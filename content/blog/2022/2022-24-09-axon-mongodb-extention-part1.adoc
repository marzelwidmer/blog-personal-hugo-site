---
author: "Marcel Widmer"
date : "2022-09-24"
title: Axon Framework with MongoDB extension and Onion Architecture - Part 1
description: "AxonIQ - Spring Boot - MongoDB extension - CQRS"
tags: [Spring Boot, Axon, CQRS]
categories: [Development]
ShowToc: true
TocOpen: true
---

image::/static/axon/axon-cqrs.jpg[]

In this blog post we look into [Axon Framework](https://www.axoniq.io) is a framework for building evolutionary, event-driven microservice systems, based on the principles of Domain Driven Design, Command-Query Responsibility Segregation (CQRS) and Event Sourcing.

We will disable the Axon Server and replaced it with the [MongoDB extension](https://github.com/AxonFramework/extension-mongo) this extension provides functionality to leverage Mongo as an EventStorageEngine (to be used by an EventStore) and TokenStore.

For more information on anything Axon, please visit our website, [Axon Framework](https://www.axoniq.io).

= Commands / Events Query

    - A command tells our application to do something
    - An event is a notification of something that _has_ happened.
    - Queries could be _simplified_ by storing a copy of the data in a form easily In many cases, updating the query models can happen asynchronously from processing the transaction: _eventual consistency_


= Project Setup

Let's create a Maven Spring Boot project with the following dependencies from [start.spring.io](https://start.spring.io)
- actuator
- webflux
- hateoas
- reactive mongodb

Run the following commands :
[source,bash]
.Create Spring Boot project
----
export KBOOT_NAME=kboot-axon
export KBOOT_APPL_NAME=KbootAxonDemoApplication
export KBOOT_APPL_DESC="Axon Demo Project"
export KBOOT_JAVA_VERS=17
export KBOOT_PACKAGE_NAME="ch.keepcalm.demo"

http https://start.spring.io/starter.tgz \
    dependencies==actuator,webflux,data-mongodb-reactive,hateoas,flapdoodle-mongo \
    description==$KBOOT_APPL_DESC \
    applicationName==$KBOOT_APPL_NAME \
    name==$KBOOT_NAME \
    groupId==ch.keepcalm \
    artifactId==$KBOOT_NAME \
    packageName==$KBOOT_PACKAGE_NAME \
    javaVersion==$KBOOT_JAVA_VERS \
    language==kotlin \
    baseDir==$KBOOT_NAME| tar -xzvf -
----

Change in de folder :
- add `banner.txt`
- replace `application.properties` with `application.yaml` configuration file.


[source,bash]
.Replace application.properties with application.yaml
----
cd $KBOOT_NAME

http https://raw.githubusercontent.com/marzelwidmer/marzelwidmer.github.io/master/img/banner.txt \
    > src/main/resources/banner.txt

rm src/main/resources/application.properties

echo "spring:
  application:
    name: $KBOOT_NAME" | > src/main/resources/application.yaml
----

== Onion Architecture


image::/static/axon/ports-and-adapter.png[]

folder structure

[source,bash]
.Application Level Source Folder Structure
----
.
├── application <1>
├── domain <2>
└── infrastructure <3>
    ├── api
    ├── client
    ├── configuration
    ├── exception
    ├── logging
    └── persistence
----

<1> Application services responsible for providing access to the domain to external clients. An application service orchestrates use cases, but does not contain business logic.
<2> Entity, ValueObject `DDD` Core Domain Model
<3> Infrastructure services. An infrastructure service provides functionality to the domain that requires additional infrastructure only available outside of the domain. The infrastructure service interface forms part of the domain, the implementation is part of the infrastructure.


[source,bash]
.Create Onion (Hexagonal) folder structure
----
mkdir -p src/main/kotlin/${KBOOT_PACKAGE_NAME//.///}/{infrastructure/{persistence/mongo,logging,exception,configuration,client,api},application,domain}
----

[source,bash]
.Top Level Source Folder Structure
----
.
└── src
    ├── main
    │   ├── kotlin
    │   │   └── ch
    │   │       └── keepcalm
    │   │           └── demo
    │   │               ├── application
    │   │               ├── domain
    │   │               └── infrastructure
    │   │                   ├── api
    │   │                   ├── client
    │   │                   ├── configuration
    │   │                   ├── exception
    │   │                   ├── logging
    │   │                   └── persistence
    │   │                       └── mongo
    │   └── resources
    └── test
        └── kotlin
            └── ch
                └── keepcalm
                    └── demo
----

Let's modify the _pom.xml_ to handle `HATEOAS` with `WebFlux`.
Search the `spring-boot-starter-hateoas` dependency and exclude the `spring-boot-starter-web`

[source,xml]
.exclude spring-boot-starter-web from spring-boot-starter-hateoas
----
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-hateoas</artifactId>
    <exclusions>
        <exclusion>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </exclusion>
    </exclusions>
</dependency>
----





== Standalone Mode

[source,bash]
.create standalone Spring profile
----
echo "spring:
  config:
    activate:
      on-profile: standalone
  mongodb:
    embedded:
      version: 5.0.6
  data:
    mongodb:
      port: 27017
"| > src/main/resources/application-standalone.yaml
----

Add _de.flapdoodle.embed.mongo_ Maven dependency as _standalone_ profile in the _pom.xml_ to start an embedded MongoDB

[source,xml]
.create maven profile standalone
----
<!-- =================  Profiles ================= -->
<profiles>
    <profile>
        <id>standalone</id>
        <dependencies>
            <dependency>
                <groupId>de.flapdoodle.embed</groupId>
                <artifactId>de.flapdoodle.embed.mongo</artifactId>
            </dependency>
        </dependencies>
    </profile>
</profiles>
----


Start the application in _standalone_ Spring and Maven profile should start the Spring Boot application with _Netty_ and embedded MongoDB with the following command:

[source,bash]
.Start SpringBoot application with standalone profile
----
SPRING_PROFILES_ACTIVE=standalone mvn clean spring-boot:run -Pstandalone
----
